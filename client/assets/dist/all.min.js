function time_start(i){timers[i]=(new Date).getTime()}function time_end(i,t){var e=(new Date).getTime(),n=e-timers[i];return t?n:void console.log(i+" "+n+"ms")}function rough_size_of_object(i){for(var t=[],e=[i],n=0;e.length;){var a=e.pop();if("boolean"==typeof a)n+=4;else if("string"==typeof a)n+=2*a.length;else if("number"==typeof a)n+=8;else if("object"==typeof a&&-1===t.indexOf(a)){t.push(a);for(var s in a)e.push(a[s])}}return n}function coords_to_index(i){return i[0]*map_size+i[1]}function origin_points(){var i=Array();return i[0]=(origin[0]-cube_size)*map_size+(origin[1]-cube_size),i[1]=(origin[0]-cube_size)*map_size+origin[1],i[2]=(origin[0]-cube_size)*map_size+(origin[1]+cube_size),i[3]=origin[0]*map_size+(origin[1]-cube_size),i[4]=origin[0]*map_size+origin[1],i[5]=origin[0]*map_size+(origin[1]+cube_size),i[6]=(origin[0]+cube_size)*map_size+(origin[1]-cube_size),i[7]=(origin[0]+cube_size)*map_size+origin[1],i[8]=(origin[0]+cube_size)*map_size+(origin[1]+cube_size),i}function Network(){function i(i){try{var t=JSON.stringify(i)}catch(e){return console.log("Invalid Json"),console.log(e),!1}return t}var t=this;!1 in window&&alert("Browser doesn't support WebSockets. Go kick rocks.");var e=!1,n=window.location.host;if("simple-rts.zimmerloe.com"==n)var a="ws://simple-rts.zimmerloe.com:9005";else var a="ws://localhost:9005";var s=new WebSocket(a);s.onclose=function(){e?ui.visual_error("WebSocket Connection closed"):ui.visual_error("Unable to establish WebSocket connection.")},s.onerror=function(i){ui.visual_error("There was an error with the WebSocket connection.")},s.onopen=function(){e=!0,t.get_map_data(origin_points()),t.get_building_data(),t.login("brian")},this.get_map_data=function(t){var e={cube_size:cube_size,map_size:map_size,resolution:resolution,origin_points:t};s.send(i({type:"get_map_data",map_params:e}))},this.get_building_data=function(){var t={origin:origin,cube_size:cube_size};s.send(i({type:"get_building_data",params:t}))},this.make_building=function(t,e){s.send(i({type:"make_building",building_type:t,coords:e}))},this.clear_building_data=function(){s.send(i({type:"clear_building_data"}))},this.login=function(t){s.send(i({type:"login",username:t}))},s.onmessage=function(i){var t=JSON.parse(i.data),e=t.type;switch(e){case"map_data":terrain.update_tilemaps(t.tilemaps);break;case"building_data":building.building_map=t.building_map,building.draw_buildings();break;case"login":controls.launch_base_button();break;default:console.log("Unkown server response")}}}function Terrain(i,t){this.terrain_canvas=document.getElementById(i),this.terrain_ctx=this.terrain_canvas.getContext("2d"),this.tile_width=t,this.tile_spacer=.5,this.cube_length=cube_size*this.tile_width,this.tmp_map_canvases=new Object,this.map_keys=Array(),this.terrain_ctx.fillStyle="red",this.needs_update=!1,this.map_ready=!1,this.update_tilemaps=function(i){for(var t in i)"undefined"==typeof this.tmp_map_canvases[t]?this.draw_tilemap(i[t],t):console.log("Already have this cached");var e=origin_points();for(var t in e){var n=e[t];this.map_keys[t]=n}this.map_ready=!0,this.draw_cached()},this.draw_tilemap=function(i,t){var e=document.createElement("canvas"),n=e.getContext("2d");e.width=this.cube_length,e.height=this.cube_length,n.translate(this.cube_length/2,this.cube_length/2),this.tmp_map_canvases[t]=e;var a=-(cube_size/2),s=-(cube_size/2),o=.5*cube_size,r=.5*cube_size;this.begin_path(n);for(var _=[{level:1},{level:.8,color:"#7A8781"},{level:.7,color:"#59842A"},{level:.6,color:"#4C7124"},{level:.57,color:"#326800"},{level:0,color:"#254e78"}],h=1;h<_.length;){for(var l=_[h].level,c=_[h-1].level,u=a;o>u;u++)for(var d=s;r>d;d++){var m=u-a,p=d-s,g=m*cube_size+p,b=i[g].height;b>=l&&c>b&&this.draw_tile(u*this.tile_width,d*this.tile_width,n)}this.update_fill(_[h].color,n),this.fill(n),this.begin_path(n),h++}},this.draw_cached=function(){this.clear_map(),ui.translation[0]>0&&(this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[0]],1.5*-this.cube_length+ui.translation[0],1.5*-this.cube_length+ui.translation[1]),this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[1]],1.5*-this.cube_length+ui.translation[0],-this.cube_length/2+ui.translation[1]),this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[2]],1.5*-this.cube_length+ui.translation[0],this.cube_length/2+ui.translation[1])),ui.translation[1]>0&&this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[3]],-this.cube_length/2+ui.translation[0],1.5*-this.cube_length+ui.translation[1]),this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[4]],-this.cube_length/2+ui.translation[0],-this.cube_length/2+ui.translation[1]),ui.translation[1]<0&&this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[5]],-this.cube_length/2+ui.translation[0],this.cube_length/2+ui.translation[1]),ui.translation[0]<0&&(this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[6]],this.cube_length/2+ui.translation[0],1.5*-this.cube_length+ui.translation[1]),this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[7]],this.cube_length/2+ui.translation[0],-this.cube_length/2+ui.translation[1]),this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[8]],this.cube_length/2+ui.translation[0],this.cube_length/2+ui.translation[1])),building.draw_buildings()},this.draw_tile=function(i,t,e){e.rect(i,t,this.tile_width-this.tile_spacer,this.tile_width-this.tile_spacer)},this.update_fill=function(i,t){t.fillStyle!=i&&(t.fillStyle=i)},this.tilemap_update_loop=function(){this.map_ready&&this.needs_update&&(this.draw_cached(),this.needs_update=!1)},this.begin_path=function(i){i.beginPath()},this.fill=function(i){i.fill()},this.stroke=function(i){i.stroke()},this.clear_map=function(){this.terrain_ctx.save(),this.terrain_ctx.setTransform(1,0,0,1,0,0),this.terrain_ctx.clearRect(0,0,doc_width,doc_height),this.terrain_ctx.restore()}}function UI(i){this.ui_id=i,this.ui_canvas=document.getElementById(i),this.ui_ctx=this.ui_canvas.getContext("2d"),this.mouse_is_down=!1,this.buffer=cube_size*terrain.tile_width/4,this.pan_amount=10,this.half_map=cube_size*terrain.tile_width/2,this.pan_amount_vertical=1.5*this.pan_amount,this.last_x,this.last_y,this.is_click=!0,this.click_callback=function(i){console.log(i)},this.translation=[0,0];var t=this;this.translate_map=function(i,t){this.translation[0]+=i,this.translation[1]+=t,terrain.needs_update=!0,this.clear_ui(),this.translation[0]>=this.half_map+this.buffer?this.load_chunk(0,-1):this.translation[1]>=this.half_map+this.buffer?this.load_chunk(1,-1):this.translation[0]<=-this.half_map-this.buffer?this.load_chunk(0,1):this.translation[1]<=-this.half_map-this.buffer&&this.load_chunk(1,1)},this.load_chunk=function(i,t){this.translation[i]=-this.translation[i]-this.buffer*t*2,terrain.map_ready=!1,origin[i]+=cube_size*t,origin_point=coords_to_index(origin);var e=origin_points(),n=Array();for(var a in e)"undefined"==typeof terrain.tmp_map_canvases[e[a]]&&n.push(e[a]);network.get_map_data(n)},this.pan_listener=function(){$("#"+this.ui_id).mousemove(function(i){if(t.is_click=!1,t.mouse_is_down&&terrain.map_ready){if(0===i.which)return t.mouse_is_down=!1,!1;var e=t.iso_to_cartesian([i.pageX,i.pageY]),n=e[0]-t.last_x,a=e[1]-t.last_y;t.translate_map(n,a),t.last_x=e[0],t.last_y=e[1]}})},this.click_listener=function(){$("#"+this.ui_id).mousedown(function(i){if(1===i.which){var e=t.iso_to_cartesian([i.pageX,i.pageY]);t.last_x=e[0],t.last_y=e[1],t.mouse_is_down=!0,t.is_click=!0}}),$("#"+this.ui_id).mouseup(function(i){if(t.mouse_is_down=!1,t.is_click&&"function"==typeof t.click_callback){var e=t.iso_to_cartesian([i.pageX,i.pageY]);e[0]=Math.floor((e[0]-t.translation[0])/terrain.tile_width)*terrain.tile_width,e[1]=Math.floor((e[1]-t.translation[1])/terrain.tile_width)*terrain.tile_width;var n=Array();n[0]=e[0]/terrain.tile_width+cube_size/2+origin[0],n[1]=e[1]/terrain.tile_width+cube_size/2+origin[1],t.click_callback(n),t.click_callback=null}})},this.highlight_tile=function(){t.ui_ctx.fillStyle="rgba(200,0,0,0.5)",$("#"+this.ui_id).mousemove(function(i){if(!t.mouse_is_down){t.clear_ui(),t.ui_ctx.beginPath();var e=t.iso_to_cartesian([i.pageX,i.pageY]);e[0]=Math.floor((e[0]-t.translation[0])/terrain.tile_width)*terrain.tile_width,e[1]=Math.floor((e[1]-t.translation[1])/terrain.tile_width)*terrain.tile_width,t.ui_ctx.rect(e[0]+t.translation[0],e[1]+t.translation[1],terrain.tile_width-terrain.tile_spacer,terrain.tile_width-terrain.tile_spacer),t.ui_ctx.fill()}})},this.keyboard_listener=function(){this.move_up=!1,this.move_up=!1,this.move_up=!1,this.move_up=!1,$(document).keydown(function(i){87==i.keyCode?t.move_up=!0:83==i.keyCode?t.move_down=!0:65==i.keyCode?t.move_left=!0:68==i.keyCode&&(t.move_right=!0)}),$(document).keyup(function(i){87==i.keyCode?t.move_up=!1:83==i.keyCode?t.move_down=!1:65==i.keyCode?t.move_left=!1:68==i.keyCode&&(t.move_right=!1)})},this.pan_map_loop=function(){this.move_up?this.translate_map(this.pan_amount_vertical,this.pan_amount_vertical):this.move_down&&this.translate_map(-this.pan_amount_vertical,-this.pan_amount_vertical),this.move_left?this.translate_map(this.pan_amount,-this.pan_amount):this.move_right&&this.translate_map(-this.pan_amount,this.pan_amount)},this.clear_ui=function(){this.ui_ctx.save(),this.ui_ctx.setTransform(1,0,0,1,0,0),this.ui_ctx.clearRect(0,0,doc_width,doc_height),this.ui_ctx.restore()},this.visual_error=function(i){$(".error_message_box .error_message").html(i),$(".error_message_box").fadeIn(600),setTimeout(function(){$(".error_message_box").fadeOut(500)},3e3)},this.iso_to_cartesian=function(i){var t=-45*Math.PI/180,e=i[0]-doc_width/2,n=2*(i[1]-doc_height/2),a=Math.cos(t),s=Math.sin(t),o=e*a-n*s,r=e*s+n*a;return[Math.round(o),Math.round(r)]}}function Controls(){var i=$(".ui_container"),t=$(".prompt_container");this.get_next_click=function(i){ui.click_callback=i},this.launch_base_button=function(){var t=$("<a>",{"class":"button",text:"Launch Base",click:function(){controls.launch_base()}});i.append(t)},this.launch_base=function(){t.html("Click to place your base starting point."),this.get_next_click(function(i){building.make_building("home_base",i)})}}function Building(i){this.building_canvas=document.getElementById(i),this.building_ctx=this.building_canvas.getContext("2d"),this.building_map,this.draw_buildings=function(){this.clear_buildings(),this.building_ctx.fillStyle="red";for(var i in this.building_map)if(null!==this.building_map[i]){var t=Math.floor(i/cube_size),e=i-t*cube_size;t-=cube_size/2,e-=cube_size/2,t=t*terrain.tile_width+ui.translation[0],e=e*terrain.tile_width+ui.translation[1],this.building_ctx.fillRect(t+10,e+10,30,30)}},this.make_building=function(i,t){network.make_building(i,t)},this.clear_buildings=function(){this.building_ctx.save(),this.building_ctx.setTransform(1,0,0,1,0,0),this.building_ctx.clearRect(0,0,doc_width,doc_height),this.building_ctx.restore()}}var time_took=Array(),timers=new Object,doc_width=$(window).width(),doc_height=$(window).height()-$(".ui_container").height(),doc_diagonal=Math.ceil(Math.sqrt(Math.pow(doc_width,2)+Math.pow(2*doc_height,2))),iso_width=Math.sqrt(Math.pow(doc_width,2)+Math.pow(doc_width/2,2)),url_resolution=location.search.split("resolution=")[1],resolution=url_resolution?parseInt(url_resolution,10):50,url_map_size=location.search.split("map_size=")[1],map_size=url_map_size?parseInt(url_map_size,10):25e5,cube_size=Math.ceil(doc_diagonal/resolution);cube_size%2==0?cube_size:cube_size++,cube_size=cube_size>52?52:cube_size;var origin=[552648,429251],origin_point=coords_to_index(origin),network=new Network,terrain=new Terrain("main",resolution),building=new Building("buildings"),ui=new UI("ui"),controls=new Controls;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(i){window.setTimeout(i,1e3/60)}}(),function i(){requestAnimFrame(i),ui.pan_map_loop(),terrain.tilemap_update_loop()}(),$(document).ready(function(){$(".canvas").each(function(){$(this).attr("width",doc_width),$(this).attr("height",doc_height);var i=$(this)[0].getContext("2d"),t=45*Math.PI/180;i.translate(doc_width/2,doc_height/2),i.scale(1,.5),i.rotate(t)}),ui.click_listener(),ui.pan_listener(),ui.highlight_tile(),ui.keyboard_listener()});