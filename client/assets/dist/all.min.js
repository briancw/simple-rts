function time_start(t){timers[t]=(new Date).getTime()}function time_end(t,i){var e=(new Date).getTime(),n=e-timers[t];return i?n:void console.log(t+" "+n+"ms")}function time(t){"undefined"==typeof timers[t]?time_start(t):time_end(t)}function cl(t){console.log(t)}function rough_size_of_object(t){for(var i=[],e=[t],n=0;e.length;){var a=e.pop();if("boolean"==typeof a)n+=4;else if("string"==typeof a)n+=2*a.length;else if("number"==typeof a)n+=8;else if("object"==typeof a&&-1===i.indexOf(a)){i.push(a);for(var s in a)e.push(a[s])}}return n}function coords_to_index(t){return t[0]*map_size+t[1]}function origin_points(){var t=Array();return t[0]=(origin[0]-cube_size)*map_size+(origin[1]-cube_size),t[1]=(origin[0]-cube_size)*map_size+origin[1],t[2]=(origin[0]-cube_size)*map_size+(origin[1]+cube_size),t[3]=origin[0]*map_size+(origin[1]-cube_size),t[4]=origin[0]*map_size+origin[1],t[5]=origin[0]*map_size+(origin[1]+cube_size),t[6]=(origin[0]+cube_size)*map_size+(origin[1]-cube_size),t[7]=(origin[0]+cube_size)*map_size+origin[1],t[8]=(origin[0]+cube_size)*map_size+(origin[1]+cube_size),t}function User(){this.auth_token=Cookies.get("auth_token"),this.check_authentication=function(){"undefined"==typeof this.auth_token?this.login():this.authenticate()},this.authenticate=function(){network.server_call("authenticate",{auth_token:this.auth_token})},this.authenticated=function(t){t?this.get_user_info():(Cookies.remove("auth_token"),cl("Failed to authenticate. Reauthenticate."))},this.login=function(){network.server_call("login",{username:"brian",password:123456})},this.update_auth_token=function(t){this.auth_token=t,Cookies.set("auth_token",t,{expires:1,path:"/"}),this.get_user_info(),cl(t)},this.get_user_info=function(){network.server_call("user_info",{auth_token:this.auth_token})},this.update_user_info=function(t){cl(t)},this.check_authentication()}function Network(){function t(t){try{var i=JSON.stringify(t)}catch(e){return console.log("Invalid Json"),console.log(e),!1}return i}var i=this;!1 in window&&alert("Browser doesn't support WebSockets. Go kick rocks.");var e=!1,n=window.location.host;if(this.queued_tasks=Object(),"simple-rts.zimmerloe.com"==n)var a="ws://simple-rts.zimmerloe.com:9005";else var a="ws://localhost:9005";var s=new WebSocket(a);s.onclose=function(){e?ui.visual_error("WebSocket Connection closed"):ui.visual_error("Unable to establish WebSocket connection.")},s.onerror=function(t){ui.visual_error("There was an error with the WebSocket connection.")},s.onopen=function(){e=!0,i.run_queued_tasks()},this.server_call=function(i,n){if(e){var a={type:i};for(var o in n)a[o]=n[o];s.send(t(a))}else{var r=(new Date).getTime();this.queued_tasks[r]={type:i,params:n}}},this.run_queued_tasks=function(){for(var t in this.queued_tasks)this.server_call(this.queued_tasks[t].type,this.queued_tasks[t].params)},this.get_map_data=function(i){var e={cube_size:cube_size,map_size:map_size,resolution:resolution,origin_points:i};s.send(t({type:"get_map_data",map_params:e}))},this.get_building_data=function(){var i={origin:origin,cube_size:cube_size};s.send(t({type:"get_building_data",params:i}))},this.make_building=function(i,e){s.send(t({type:"make_building",building_type:i,coords:e}))},this.clear_building_data=function(){s.send(t({type:"clear_building_data"}))},this.login=function(i){s.send(t({type:"login",username:i}))},s.onmessage=function(t){var i=JSON.parse(t.data),e=i.type;switch(e){case"map_data":terrain.update_tilemaps(i.tilemaps);break;case"building_data":building.building_map=i.building_map,building.draw_buildings();break;case"login":user.update_auth_token(i.auth_token);break;case"authenticate":user.authenticated(i.success);break;case"user_info":user.update_user_info(i.user_info);break;case"world_map_data":world.update_worldmap(i.world_tilemap);break;default:console.log("Unkown server response")}}}function Terrain(t,i){this.terrain_canvas=document.getElementById(t),this.terrain_ctx=this.terrain_canvas.getContext("2d"),this.tile_width=i,this.tile_spacer=.5,this.cube_length=cube_size*this.tile_width,this.tmp_map_canvases=new Object,this.map_keys=Array(),this.terrain_ctx.fillStyle="red",this.needs_update=!1,this.map_ready=!1,this.update_tilemaps=function(t){for(var i in t)"undefined"==typeof this.tmp_map_canvases[i]?this.draw_tilemap(t[i],i):console.log("Already have this cached");var e=origin_points();for(var i in e){var n=e[i];this.map_keys[i]=n}this.map_ready=!0,this.draw_cached()},this.draw_tilemap=function(t,i){var e=document.createElement("canvas"),n=e.getContext("2d");e.width=this.cube_length,e.height=this.cube_length,n.translate(this.cube_length/2,this.cube_length/2),this.tmp_map_canvases[i]=e;this.begin_path(n);for(var a in t){this.begin_path(n),this.update_fill(t[a].color,n);for(var s in t[a].tiles)this.draw_tile(t[a].tiles[s].x-cube_size/2,t[a].tiles[s].y-cube_size/2,n);this.fill(n)}},this.draw_cached=function(){this.clear_map(),ui.translation[0]>0&&(this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[0]],1.5*-this.cube_length+ui.translation[0],1.5*-this.cube_length+ui.translation[1]),this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[1]],1.5*-this.cube_length+ui.translation[0],-this.cube_length/2+ui.translation[1]),this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[2]],1.5*-this.cube_length+ui.translation[0],this.cube_length/2+ui.translation[1])),ui.translation[1]>0&&this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[3]],-this.cube_length/2+ui.translation[0],1.5*-this.cube_length+ui.translation[1]),this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[4]],-this.cube_length/2+ui.translation[0],-this.cube_length/2+ui.translation[1]),ui.translation[1]<0&&this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[5]],-this.cube_length/2+ui.translation[0],this.cube_length/2+ui.translation[1]),ui.translation[0]<0&&(this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[6]],this.cube_length/2+ui.translation[0],1.5*-this.cube_length+ui.translation[1]),this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[7]],this.cube_length/2+ui.translation[0],-this.cube_length/2+ui.translation[1]),this.terrain_ctx.drawImage(this.tmp_map_canvases[this.map_keys[8]],this.cube_length/2+ui.translation[0],this.cube_length/2+ui.translation[1])),building.draw_buildings()},this.draw_tile=function(t,i,e){e.rect(t*this.tile_width,i*this.tile_width,this.tile_width-this.tile_spacer,this.tile_width-this.tile_spacer)},this.update_fill=function(t,i){i.fillStyle!=t&&(i.fillStyle=t)},this.tilemap_update_loop=function(){this.map_ready&&this.needs_update&&(this.draw_cached(),this.needs_update=!1)},this.begin_path=function(t){t.beginPath()},this.fill=function(t){t.fill()},this.stroke=function(t){t.stroke()},this.clear_map=function(){this.terrain_ctx.save(),this.terrain_ctx.setTransform(1,0,0,1,0,0),this.terrain_ctx.clearRect(0,0,doc_width,doc_height),this.terrain_ctx.restore()}}function UI(t){this.ui_id=t,this.ui_canvas=document.getElementById(t),this.ui_ctx=this.ui_canvas.getContext("2d"),this.mouse_is_down=!1,this.buffer=cube_size*terrain.tile_width/4,this.pan_amount=10,this.half_map=cube_size*terrain.tile_width/2,this.pan_amount_vertical=1.5*this.pan_amount,this.last_x,this.last_y,this.is_click=!0,this.click_callback=null,this.translation=[0,0];var i=this;this.translate_map=function(t,i){this.translation[0]+=t,this.translation[1]+=i,terrain.needs_update=!0,this.clear_ui(),this.translation[0]>=this.half_map+this.buffer?this.load_chunk(0,-1):this.translation[1]>=this.half_map+this.buffer?this.load_chunk(1,-1):this.translation[0]<=-this.half_map-this.buffer?this.load_chunk(0,1):this.translation[1]<=-this.half_map-this.buffer&&this.load_chunk(1,1)},this.load_chunk=function(t,i){this.translation[t]=-this.translation[t]-this.buffer*i*2,terrain.map_ready=!1,origin[t]+=cube_size*i,origin_point=coords_to_index(origin);var e=origin_points(),n=Array();for(var a in e)"undefined"==typeof terrain.tmp_map_canvases[e[a]]&&n.push(e[a]);network.get_map_data(n)},this.pan_listener=function(){$("#"+this.ui_id).mousemove(function(t){if(i.is_click=!1,i.mouse_is_down&&terrain.map_ready){if(0===t.which)return i.mouse_is_down=!1,!1;var e=i.iso_to_cartesian([t.pageX,t.pageY]),n=e[0]-i.last_x,a=e[1]-i.last_y;i.translate_map(n,a),i.last_x=e[0],i.last_y=e[1]}})},this.click_listener=function(){$("#"+this.ui_id).mousedown(function(t){if(1===t.which){var e=i.iso_to_cartesian([t.pageX,t.pageY]);i.last_x=e[0],i.last_y=e[1],i.mouse_is_down=!0,i.is_click=!0}}),$("#"+this.ui_id).mouseup(function(t){if(i.mouse_is_down=!1,i.is_click&&"function"==typeof i.click_callback){var e=i.iso_to_cartesian([t.pageX,t.pageY]);e[0]=Math.floor((e[0]-i.translation[0])/terrain.tile_width)*terrain.tile_width,e[1]=Math.floor((e[1]-i.translation[1])/terrain.tile_width)*terrain.tile_width;var n=Array();n[0]=e[0]/terrain.tile_width+cube_size/2+origin[0],n[1]=e[1]/terrain.tile_width+cube_size/2+origin[1],i.click_callback(n),i.click_callback=null}})},this.highlight_tile=function(){i.ui_ctx.fillStyle="rgba(200,0,0,0.5)",$("#"+this.ui_id).mousemove(function(t){if(!i.mouse_is_down){i.clear_ui(),i.ui_ctx.beginPath();var e=i.iso_to_cartesian([t.pageX,t.pageY]);e[0]=Math.floor((e[0]-i.translation[0])/terrain.tile_width)*terrain.tile_width,e[1]=Math.floor((e[1]-i.translation[1])/terrain.tile_width)*terrain.tile_width,i.ui_ctx.rect(e[0]+i.translation[0],e[1]+i.translation[1],terrain.tile_width-terrain.tile_spacer,terrain.tile_width-terrain.tile_spacer),i.ui_ctx.fill()}})},this.keyboard_listener=function(){this.move_up=!1,this.move_up=!1,this.move_up=!1,this.move_up=!1,$(document).keydown(function(t){87==t.keyCode?i.move_up=!0:83==t.keyCode?i.move_down=!0:65==t.keyCode?i.move_left=!0:68==t.keyCode&&(i.move_right=!0)}),$(document).keyup(function(t){87==t.keyCode?i.move_up=!1:83==t.keyCode?i.move_down=!1:65==t.keyCode?i.move_left=!1:68==t.keyCode&&(i.move_right=!1)})},this.pan_map_loop=function(){this.move_up?this.translate_map(this.pan_amount_vertical,this.pan_amount_vertical):this.move_down&&this.translate_map(-this.pan_amount_vertical,-this.pan_amount_vertical),this.move_left?this.translate_map(this.pan_amount,-this.pan_amount):this.move_right&&this.translate_map(-this.pan_amount,this.pan_amount)},this.clear_ui=function(){this.ui_ctx.save(),this.ui_ctx.setTransform(1,0,0,1,0,0),this.ui_ctx.clearRect(0,0,doc_width,doc_height),this.ui_ctx.restore()},this.visual_error=function(t){$(".error_message_box .error_message").html(t),$(".error_message_box").fadeIn(600),setTimeout(function(){$(".error_message_box").fadeOut(500)},3e3)},this.iso_to_cartesian=function(t){var i=-45*Math.PI/180,e=t[0]-doc_width/2,n=2*(t[1]-doc_height/2),a=Math.cos(i),s=Math.sin(i),o=e*a-n*s,r=e*s+n*a;return[Math.round(o),Math.round(r)]}}function Controls(){var t=$(".ui_container"),i=$(".prompt_container");this.get_next_click=function(t){ui.click_callback=t},this.launch_base_button=function(){var i=$("<a>",{"class":"button",text:"Launch Base",click:function(){controls.launch_base()}});t.append(i)},this.launch_base=function(){i.html("Click to place your base starting point."),this.get_next_click(function(t){building.make_building("home_base",t)})}}function Building(t){this.building_canvas=document.getElementById(t),this.building_ctx=this.building_canvas.getContext("2d"),this.building_map,this.draw_buildings=function(){this.clear_buildings(),this.building_ctx.fillStyle="red";for(var t in this.building_map)if(null!==this.building_map[t]){var i=Math.floor(t/cube_size),e=t-i*cube_size;i-=cube_size/2,e-=cube_size/2,i=i*terrain.tile_width+ui.translation[0],e=e*terrain.tile_width+ui.translation[1],this.building_ctx.fillRect(i+10,e+10,30,30)}},this.make_building=function(t,i){network.make_building(t,i)},this.clear_buildings=function(){this.building_ctx.save(),this.building_ctx.setTransform(1,0,0,1,0,0),this.building_ctx.clearRect(0,0,doc_width,doc_height),this.building_ctx.restore()}}function World(t){this.world_canvas=document.getElementById(t),this.world_ctx=this.world_canvas.getContext("2d"),this.world_canvas.width=doc_width,this.world_canvas.height=doc_height,this.tile_width=4,this.get_world_map=function(){network.server_call("world_map_data",{map_size:doc_height/this.tile_width,cube_size:doc_height/this.tile_width})},this.update_worldmap=function(t){for(var i in t){this.update_fill(t[i].color),this.path();for(var e in t[i].tiles)this.draw_tile(t[i].tiles[e].x,t[i].tiles[e].y);this.fill()}this.world_ctx.fillStyle="red";var n=origin[0]/25e5*doc_height,a=origin[1]/25e5*doc_height;this.world_ctx.fillRect(n,a,3,3)},this.fill=function(){this.world_ctx.fill()},this.draw_tile=function(t,i){this.world_ctx.rect(t*this.tile_width,i*this.tile_width,this.tile_width,this.tile_width)},this.path=function(){this.world_ctx.beginPath()},this.update_fill=function(t){this.world_ctx.fillStyle!=t&&(this.world_ctx.fillStyle=t)}}!function(t){if("function"==typeof define&&define.amd)define(t);else if("object"==typeof exports)module.exports=t();else{var i=window.Cookies,e=window.Cookies=t(window.jQuery);e.noConflict=function(){return window.Cookies=i,e}}}(function(){function t(){for(var t=0,i={};t<arguments.length;t++){var e=arguments[t];for(var n in e)i[n]=e[n]}return i}function i(e){function n(i,a,s){var o;if(arguments.length>1){if(s=t({path:"/"},n.defaults,s),"number"==typeof s.expires){var r=new Date;r.setMilliseconds(r.getMilliseconds()+864e5*s.expires),s.expires=r}try{o=JSON.stringify(a),/^[\{\[]/.test(o)&&(a=o)}catch(_){}return a=encodeURIComponent(String(a)),a=a.replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),i=encodeURIComponent(String(i)),i=i.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),i=i.replace(/[\(\)]/g,escape),document.cookie=[i,"=",a,s.expires&&"; expires="+s.expires.toUTCString(),s.path&&"; path="+s.path,s.domain&&"; domain="+s.domain,s.secure?"; secure":""].join("")}i||(o={});for(var h=document.cookie?document.cookie.split("; "):[],c=/(%[0-9A-Z]{2})+/g,l=0;l<h.length;l++){var u=h[l].split("="),d=u[0].replace(c,decodeURIComponent),p=u.slice(1).join("=");if('"'===p.charAt(0)&&(p=p.slice(1,-1)),p=e&&e(p,d)||p.replace(c,decodeURIComponent),this.json)try{p=JSON.parse(p)}catch(_){}if(i===d){o=p;break}i||(o[d]=p)}return o}return n.get=n.set=n,n.getJSON=function(){return n.apply({json:!0},[].slice.call(arguments))},n.defaults={},n.remove=function(i,e){n(i,"",t(e,{expires:-1}))},n.withConverter=i,n}return i()});var time_took=Array(),timers=new Object,doc_width=$(window).width(),doc_height=$(window).height()-$(".ui_container").height(),doc_diagonal=Math.ceil(Math.sqrt(Math.pow(doc_width,2)+Math.pow(2*doc_height,2))),iso_width=Math.sqrt(Math.pow(doc_width,2)+Math.pow(doc_width/2,2)),url_resolution=location.search.split("resolution=")[1],resolution=url_resolution?parseInt(url_resolution,10):50,url_map_size=location.search.split("map_size=")[1],map_size=url_map_size?parseInt(url_map_size,10):25e5,cube_size=Math.ceil(doc_diagonal/resolution);cube_size%2==0?cube_size:cube_size++,cube_size=cube_size>52?52:cube_size;var origin=[552648,429251],origin_point=coords_to_index(origin),network=new Network,user=new User,terrain=new Terrain("main",resolution),building=new Building("buildings"),ui=new UI("ui"),controls=new Controls,world=new World("world");window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),function t(){requestAnimFrame(t),ui.pan_map_loop(),terrain.tilemap_update_loop()}(),$(document).ready(function(){$(".canvas").not("#world").each(function(){$(this).attr("width",doc_width),$(this).attr("height",doc_height);var t=$(this)[0].getContext("2d"),i=45*Math.PI/180;t.translate(doc_width/2,doc_height/2),t.scale(1,.5),t.rotate(i)}),ui.click_listener(),ui.pan_listener(),ui.highlight_tile(),ui.keyboard_listener()});